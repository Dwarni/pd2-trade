name: "publish"

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  ########################################################################
  # 1. Create Release in errolgr/pd2-trade
  ########################################################################
  create-release:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create-release.outputs.result }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Get version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "PACKAGE_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Create release in pd2-trade
        id: create-release
        uses: actions/github-script@v7
        with:
          script: |
            const { data } = await github.rest.repos.createRelease({
              owner: "errolgr",            // target owner
              repo: "pd2-trade",         // target release repo
              tag_name: `app-v${process.env.PACKAGE_VERSION}`,
              name: `PD2 Trader v${process.env.PACKAGE_VERSION}`,
              body: 'Take a look at the assets to download and install this app.',
              draft: true,
              prerelease: false
            });
            return data.id;

  ########################################################################
  # 2. Build Tauri (unchanged)
  ########################################################################
  build-tauri:
    needs: create-release
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: "windows-latest"
            args: ""
          - platform: "ubuntu-22.04"
            args: ""
          # Add more platforms as needed...
    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Install dependencies (ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: >
          sudo apt-get update && 
          sudo apt-get install -y build-essential pkg-config libx11-dev libxi-dev 
          libxtst-dev libglib2.0-dev libgdk-pixbuf2.0-dev libsoup-3.0-dev 
          libnotify-dev libatk1.0-dev libwebkit2gtk-4.1-dev libayatana-appindicator3-dev 
          xdg-utils librsvg2-dev patchelf file 

      - name: Install frontend dependencies
        run: npm install

      - uses: tauri-apps/tauri-action@v0.5.20
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          GITHUB_TOKEN: ${{ secrets.PD2_GITHUB_TOKEN }}
        with:
          releaseId: ${{ needs.create-release.outputs.release_id }}
          owner: errolgr
          repo: pd2-trade
          args: ${{ matrix.args }}

  ########################################################################
  # 3. Publish Release in pd2-trade
  ########################################################################
  publish-release:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    needs: [create-release, build-tauri]
    steps:
      - name: Publish release in pd2-trade
        id: publish-release
        uses: actions/github-script@v6
        env:
          release_id: ${{ needs.create-release.outputs.release_id }}
        with:
          script: |
            await github.rest.repos.updateRelease({
              owner: "errolgr",            // target owner
              repo: "pd2-trade",         // target release repo
              release_id: process.env.release_id,
              draft: false,
              prerelease: false
            });

  ########################################################################
  # 4. Send Discord Notification
  ########################################################################
  discord-notification:
    permissions:
      contents: read
    runs-on: ubuntu-latest
    needs: [publish-release]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          node << 'EOF'
          const fs = require('fs');
          const https = require('https');
          const { execSync } = require('child_process');
          
          // Get version from package.json
          const packageJson = JSON.parse(fs.readFileSync('./package.json', 'utf8'));
          const version = packageJson.version;
          const currentTag = `app-v${version}`;
          
          // Get previous tag
          execSync('git fetch --tags', { stdio: 'inherit' });
          const tags = execSync('git tag --sort=-v:refname')
            .toString()
            .trim()
            .split('\n')
            .filter(tag => /^app-v\d+\.\d+\.\d+$/.test(tag));
          
          const previousTag = tags.length > 1 ? tags[1] : 'app-v0.0.0';
          const compareUrl = `https://github.com/errolgr/pd2-trade/compare/${previousTag}...${currentTag}`;
          
          // Extract changelog entries for this version
          const content = fs.readFileSync('./src/assets/changeLog.ts', 'utf8');
          const versionRegex = new RegExp(`"${version.replace(/\./g, '\\.')}":\\s*\\[([\\s\\S]*?)\\]`, 'm');
          const match = content.match(versionRegex);
          
          let changelogText = 'No changelog entries found for this version.';
          if (match) {
            const entriesBlock = match[1];
            // Extract string entries, handling escaped strings
            const entries = [];
            const stringRegex = /"([^"\\]|\\.)*"/g;
            let m;
            while ((m = stringRegex.exec(entriesBlock)) !== null) {
              // Unescape the string
              const entry = m[0]
                .slice(1, -1) // Remove quotes
                .replace(/\\n/g, '\n')
                .replace(/\\"/g, '"')
                .replace(/\\\\/g, '\\');
              entries.push(entry);
            }
            
            // Format with bullet points
            changelogText = entries.map(entry => `â€¢ ${entry}`).join('\n');
          }
          
          // Create Discord embed payload
          const payload = {
            embeds: [{
              title: `ðŸš€ PD2 Trader v${version} Released`,
              description: changelogText,
              color: 3447003,
              fields: [
                {
                  name: 'ðŸ“¦ Download',
                  value: `[View Release](https://github.com/errolgr/pd2-trade/releases/tag/${currentTag})`,
                  inline: true
                },
                {
                  name: 'ðŸ“ Code Changes',
                  value: `[View Changes](${compareUrl})`,
                  inline: true
                }
              ],
              footer: {
                text: 'PD2 Trader'
              },
              timestamp: new Date().toISOString()
            }]
          };
          
          // Send to Discord
          const webhookUrl = process.env.DISCORD_WEBHOOK_URL;
          if (!webhookUrl) {
            console.log('DISCORD_WEBHOOK_URL not set, skipping Discord notification');
            process.exit(0);
          }
          
          const url = new URL(webhookUrl);
          const postData = JSON.stringify(payload);
          
          const options = {
            hostname: url.hostname,
            port: url.port || 443,
            path: url.pathname + url.search,
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Content-Length': Buffer.byteLength(postData)
            }
          };
          
          const req = https.request(options, (res) => {
            let data = '';
            res.on('data', (chunk) => { data += chunk; });
            res.on('end', () => {
              if (res.statusCode >= 200 && res.statusCode < 300) {
                console.log('Discord notification sent successfully');
              } else {
                console.error(`Discord webhook failed: ${res.statusCode} ${data}`);
                process.exit(1);
              }
            });
          });
          
          req.on('error', (error) => {
            console.error(`Error sending Discord notification: ${error.message}`);
            process.exit(1);
          });
          
          req.write(postData);
          req.end();
          EOF
