name: "Test Discord Webhook"

on:
  workflow_dispatch:

jobs:
  test-discord-notification:
    permissions:
      contents: read
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Test Discord notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          node << 'EOF'
          const fs = require('fs');
          const https = require('https');
          const { execSync } = require('child_process');
          
          // Get version from package.json
          const packageJson = JSON.parse(fs.readFileSync('./package.json', 'utf8'));
          const version = packageJson.version;
          const currentTag = `app-v${version}`;
          
          // Get previous tag
          execSync('git fetch --tags', { stdio: 'inherit' });
          const tags = execSync('git tag --sort=-v:refname')
            .toString()
            .trim()
            .split('\n')
            .filter(tag => /^app-v\d+\.\d+\.\d+$/.test(tag));
          
          const previousTag = tags.length > 1 ? tags[1] : 'app-v0.0.0';
          const compareUrl = `https://github.com/errolgr/pd2-trade/compare/${previousTag}...${currentTag}`;
          
          // Extract changelog entries for this version
          const content = fs.readFileSync('./src/assets/changeLog.ts', 'utf8');
          const versionRegex = new RegExp(`"${version.replace(/\./g, '\\.')}":\\s*\\[([\\s\\S]*?)\\]`, 'm');
          const match = content.match(versionRegex);
          
          let changelogText = 'No changelog entries found for this version.';
          if (match) {
            const entriesBlock = match[1];
            // Extract string entries, handling escaped strings
            const entries = [];
            const stringRegex = /"([^"\\]|\\.)*"/g;
            let m;
            while ((m = stringRegex.exec(entriesBlock)) !== null) {
              // Unescape the string
              const entry = m[0]
                .slice(1, -1) // Remove quotes
                .replace(/\\n/g, '\n')
                .replace(/\\"/g, '"')
                .replace(/\\\\/g, '\\');
              entries.push(entry);
            }
            
            // Format with bullet points
            changelogText = entries.map(entry => `â€¢ ${entry}`).join('\n');
          }
          
          // Create Discord embed payload
          const payload = {
            embeds: [{
              title: `ðŸ§ª TEST: PD2 Trader v${version} Released`,
              description: changelogText,
              color: 15158332, // Red color for test
              fields: [
                {
                  name: 'ðŸ“¦ Download',
                  value: `[View Release](https://github.com/errolgr/pd2-trade/releases/tag/${currentTag})`,
                  inline: true
                },
                {
                  name: 'ðŸ“ Code Changes',
                  value: `[View Changes](${compareUrl})`,
                  inline: true
                }
              ],
              footer: {
                text: 'PD2 Trader - TEST MESSAGE'
              },
              timestamp: new Date().toISOString()
            }]
          };
          
          // Send to Discord
          const webhookUrl = process.env.DISCORD_WEBHOOK_URL;
          if (!webhookUrl) {
            console.log('DISCORD_WEBHOOK_URL not set, skipping Discord notification');
            process.exit(0);
          }
          
          const url = new URL(webhookUrl);
          const postData = JSON.stringify(payload);
          
          const options = {
            hostname: url.hostname,
            port: url.port || 443,
            path: url.pathname + url.search,
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Content-Length': Buffer.byteLength(postData)
            }
          };
          
          const req = https.request(options, (res) => {
            let data = '';
            res.on('data', (chunk) => { data += chunk; });
            res.on('end', () => {
              if (res.statusCode >= 200 && res.statusCode < 300) {
                console.log('Discord notification sent successfully');
              } else {
                console.error(`Discord webhook failed: ${res.statusCode} ${data}`);
                process.exit(1);
              }
            });
          });
          
          req.on('error', (error) => {
            console.error(`Error sending Discord notification: ${error.message}`);
            process.exit(1);
          });
          
          req.write(postData);
          req.end();
          EOF

